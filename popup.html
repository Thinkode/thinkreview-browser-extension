<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ThinkReview</title>
  <link rel="stylesheet" href="popup.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
  <div id="popup-container">
    <header class="app-header">
      <div class="header-top-row">
        <div class="title-with-logo">
          <img src="images/icon48.png" alt="ThinkReview Logo" class="header-logo">
          <h2>ThinkReview</h2>
        </div>
      </div>
      <div class="header-bottom-row">
        <div class="header-auth-section">
          <google-signin></google-signin>
          <div id="portal-buttons-row" class="portal-buttons-row" style="display: none;">
            <button 
              id="dashboard-btn" 
              class="portal-button"
              aria-label="Open Dashboard - Opens in new tab"
              title="Dashboard">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              <span>Dashboard</span>
            </button>
            <button 
              id="analytics-btn" 
              class="portal-button"
              aria-label="Open Analytics - Opens in new tab"
              title="Analytics">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 3v18h18"></path>
                <rect x="5" y="8" width="3" height="10"></rect>
                <rect x="10" y="5" width="3" height="13"></rect>
                <rect x="15" y="11" width="3" height="7"></rect>
              </svg>
              <span>Analytics</span>
            </button>
            <button 
              id="model-selection-btn" 
              class="portal-button"
              aria-label="Open Model Selection - Opens in new tab"
              title="Model Selection">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
              </svg>
              <span>Model Selection</span>
            </button>
            <button 
              id="scoring-metrics-btn" 
              class="portal-button"
              aria-label="Open Custom Rules - Opens in new tab"
              title="Custom Rules">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
              </svg>
              <span>Custom Rules</span>
            </button>
            <button 
              id="signout-btn" 
              class="portal-button signout-portal-button"
              aria-label="Sign out"
              title="Sign out">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
              </svg>
              <span>Sign out</span>
            </button>
          </div>
        </div>
        <p id="login-prompt" class="login-prompt" style="display: none;">Please login to continue</p>
        <div id="privacy-policy-text" class="privacy-policy-text" style="display: none;">
          <div class="privacy-policy-icon">üîí</div>
          <p class="privacy-policy-content">
            By signing up you agree to our <a href="https://thinkreview.dev/privacy-policy" target="_blank" rel="noopener noreferrer" class="privacy-policy-link">Privacy Policy</a>
          </p>
        </div>
      </div>
    </header>
    
    <!-- Welcome Section for Non-Logged-In Users -->
    <div id="welcome-content" class="welcome-content" style="display: none;">
      <div class="welcome-hero">
        <div class="welcome-title">
          <h2>AI-Powered Code Reviews</h2>
          <div class="gemini-badge">Powered by Frontier Models & Ollama</div>
        </div>
        <p class="welcome-subtitle">Transform your GitLab, GitHub and Azure DevOps PR workflow with intelligent AI code analysis</p>
      </div>
      
      <!-- Feature Preview Cards -->
      <div class="feature-preview-grid">
        <div class="feature-preview-card">
          <div class="feature-icon ai-powered">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h3>Instant AI Reviews</h3>
          <p>Get comprehensive code reviews in seconds</p>
        </div>
        
        <div class="feature-preview-card">
          <div class="feature-icon ai-powered">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
            </svg>
          </div>
          <h3>GitLab, GitHub & Azure DevOps Integration</h3>
          <p>Seamlessly integrated into your workflow</p>
        </div>
        
        <div class="feature-preview-card">
          <div class="feature-icon ai-powered">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <h3>Privacy Protected</h3>
          <p>Your code never stored on our servers. <a href="https://thinkreview.dev/privacy-faqs.html" target="_blank" rel="noopener noreferrer" class="privacy-notice-link">Check Privacy FAQs</a></p>
        </div>
      </div>
      
      <!-- Sign-in CTA -->
      <div class="signin-cta">
        <p class="signin-message">Sign in to start generating AI reviews for your GitLab merge requests, GitHub pull requests and Azure DevOps pull requests</p>
      </div>
      
      <!-- Zero Setup Preview -->
      <div class="zero-setup-preview">
        <div class="zero-setup-icon">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div class="zero-setup-text">
          <strong>Zero Setup Required</strong> - No API keys, no tokens, works instantly!
        </div>
      </div>
    </div>

    <div id="authenticated-content">
      <div id="current-status">Loading...</div>
      <div id="review-count-section" class="review-count-section">
        <div class="review-count-label">Total AI Reviews Generated:</div>
        <div id="review-count" class="review-count">-</div>
      </div>
      
      <!-- Subscription Status Section -->
      <div id="subscription-status-section" class="subscription-status-section">
        <div class="subscription-status-label">Current Plan:</div>
        <div id="subscription-status" class="subscription-status">Free Plan</div>
        <div id="next-payment-info" class="next-payment-info" style="display: none;">
          <div class="next-payment-container">
            <div class="next-payment-label">Valid To:</div>
            <div id="next-payment-date" class="next-payment-date">-</div>
          </div>
        </div>
        <div id="cancel-subscription-container" style="display: none;" class="cancel-subscription-container">
          <button id="cancel-subscription-btn" class="cancel-subscription-btn">Manage Subscription</button>
        </div>
      </div>
      
      <!-- AI Provider Settings Section -->
      <div id="ai-provider-settings" class="ai-provider-settings-section">
        <h3 class="settings-title">AI Provider</h3>
        <p class="settings-description">Choose between cloud-based AI or local Ollama</p>
        
        <div class="provider-selection">
          <label class="provider-option">
            <input type="radio" name="ai-provider" value="cloud" id="provider-cloud" checked>
            <div class="provider-info">
              <span class="provider-name">‚òÅÔ∏è Cloud AI (Advanced Models)</span>
              <span class="provider-desc">Fast, powerful, internet required</span>
            </div>
          </label>
          
          <label class="provider-option">
            <input type="radio" name="ai-provider" value="ollama" id="provider-ollama">
            <div class="provider-info">
              <span class="provider-name">üñ•Ô∏è Local Ollama</span>
              <span class="provider-desc">Private, offline, requires setup</span>
            </div>
          </label>
        </div>
        
        <!-- Ollama Configuration (hidden by default) -->
        <div id="ollama-config" class="ollama-config" style="display: none;">
          <div class="ollama-config-row">
            <label for="ollama-url" class="config-label">Ollama URL:</label>
            <input type="text" id="ollama-url" class="config-input" value="http://localhost:11434" placeholder="http://localhost:11434">
          </div>
          
          <div class="ollama-config-row">
            <label for="ollama-model" class="config-label">Model:</label>
            <div class="model-select-wrapper">
              <select id="ollama-model" class="config-select">
                <option value="">Loading models...</option>
              </select>
              <button id="refresh-models-btn" class="refresh-models-btn" title="Refresh available models">üîÑ</button>
            </div>
          </div>
          
          <div class="ollama-actions">
            <button id="test-ollama-btn" class="test-ollama-btn">Test Connection</button>
            <button id="save-ollama-btn" class="save-ollama-btn">Save Settings</button>
          </div>
          
          <div id="ollama-status" class="ollama-status"></div>
          
          <div class="ollama-help">
            <p class="help-text">
              <strong>üìñ <a href="https://github.com/Thinkode/thinkreview-browser-extension/blob/main/OLLAMA_SETUP.md" target="_blank">Full Setup Guide</a></strong> - Complete instructions with model recommendations & troubleshooting
            </p>
          </div>
        </div>
      </div>
      
      <!-- Domain Settings Section -->
      <div id="domain-settings" class="domain-settings-section">
        <h3 class="settings-title">GitLab Domains</h3>
        <p class="settings-description">Add custom GitLab domains where the extension should work</p>
        
        <div class="domain-input-section">
          <input type="text" id="domain-input" placeholder="e.g., gitlab.example.com, localhost:8083" class="domain-input">
          <button id="add-domain-btn" class="add-domain-btn">Add</button>
        </div>
        
        <div id="domain-list" class="domain-list">
          <!-- Domain items will be populated by JavaScript -->
        </div>
      </div>
      
      <!-- Azure DevOps Settings Section -->
      <div id="azure-settings" class="azure-settings-section">
        <h3 class="settings-title">Azure DevOps Integration</h3>
        <p class="settings-description">Configure your Azure DevOps Personal Access Token for code review functionality</p>
        
        <div class="token-input-section">
          <input type="password" id="azure-token-input" placeholder="Enter your Azure DevOps Personal Access Token" class="token-input">
          <button id="save-token-btn" class="save-token-btn">Save Token</button>
        </div>
        
        <div id="token-status" class="token-status">
          <!-- Token status will be populated by JavaScript -->
        </div>
        
        <div class="token-help">
          <p class="help-text">
            <strong>How to get your token:</strong><br>
            1. Go to Azure DevOps ‚Üí User Settings ‚Üí Personal Access Tokens<br>
            2. Create a new token with "Code (read)" permissions<br>
            3. Copy the token and paste it above
          </p>
        </div>
        
        <div id="azure-domain-settings" class="domain-settings-section">
          <h3 class="settings-title">Azure DevOps Domains</h3>
          <p class="settings-description">Add custom Azure DevOps domains (e.g. on-prem) where the extension should work</p>
          
          <div class="domain-input-section">
            <input type="text" id="azure-domain-input" placeholder="e.g., devops.companyname.com" class="domain-input">
            <button id="add-azure-domain-btn" class="add-domain-btn">Add</button>
          </div>
          
          <div id="azure-domain-list" class="domain-list">
            <!-- Domain items will be populated by JavaScript -->
          </div>
        </div>
      </div>
      
      <!-- GitHub Settings Section -->
      <div id="github-settings" class="github-settings-section">
        <h3 class="settings-title">GitHub Integration</h3>
        <p class="settings-description">ThinkReview is ready to work on GitHub pull requests</p>
        
        <div class="github-info">
          <div class="github-info-icon thinkreview-tick-green">‚úì</div>
          <div class="github-info-content">
            <p class="github-info-text">
              <strong>No setup required!</strong> The extension automatically works on GitHub pull requests. Simply navigate to any GitHub PR page to start generating AI code reviews.
            </p>
          </div>
        </div>
      </div>
      
      <!-- Bitbucket Settings Section -->
      <div id="bitbucket-settings" class="bitbucket-settings-section">
        <div class="bitbucket-header-row">
          <h3 class="settings-title">Bitbucket Integration</h3>
          <div id="bitbucket-allow-section" class="bitbucket-allow-section">
            <div class="bitbucket-allow-button-row">
              <button id="allow-bitbucket-btn" class="add-domain-btn">Allow Bitbucket</button>
              <span id="bitbucket-status" class="bitbucket-status"></span>
            </div>
            <p class="help-text bitbucket-allow-hint">You must grant permission by pressing the button above to use ThinkReview on Bitbucket.</p>
          </div>
        </div>
        <div id="bitbucket-enabled-message" class="github-info" style="display: none;">
          <div class="github-info-icon thinkreview-tick-green">‚úì</div>
          <div class="github-info-content">
            <p class="github-info-text">
              <strong>Bitbucket enabled.</strong> Reload Bitbucket pull request pages to use AI code reviews.
            </p>
          </div>
        </div>
        <div id="bitbucket-token-section" class="token-input-section bitbucket-token-section">
          <input type="email" id="bitbucket-email-input" placeholder="Atlassian account email (for API token)" class="token-input bitbucket-email-input">
          <input type="password" id="bitbucket-token-input" class="token-input" placeholder="Paste your Bitbucket API token or app password" aria-label="Bitbucket API token">
          <button id="save-bitbucket-token-btn" class="save-token-btn">Save Token</button>
        </div>
        <div id="bitbucket-token-status" class="token-status bitbucket-token-status"></div>
        <p class="help-text">For API tokens use your Atlassian account email + token. For app passwords use Bitbucket username + app password.</p>
        <p class="help-text"><a href="https://thinkreview.dev/docs/bitbucket-integration" target="_blank" rel="noopener noreferrer">How to generate a Bitbucket token</a></p>
      </div>
    </div>
    
    <footer class="app-footer">
      <div class="footer-buttons-left">
        <button 
          id="need-help-btn" 
          class="footer-button"
          aria-label="Get help with problems - Opens in new tab"
          title="Get help with problems">
          Having Problems?
        </button>
        <button 
          id="report-bug-btn" 
          class="footer-button"
          aria-label="Report a bug - Opens in new tab"
          title="Report a bug">
          Report a Bug
        </button>
      </div>
      <button 
        id="how-it-works-btn" 
        class="footer-button"
        aria-label="View how ThinkReview works - Opens in new tab"
        title="View how ThinkReview works">
        How it works
      </button>
    </footer>
  </div>
  
  <script type="module" src="popup-imports.js"></script>
  <script type="module" src="popup.js"></script>
</body>
</html>
